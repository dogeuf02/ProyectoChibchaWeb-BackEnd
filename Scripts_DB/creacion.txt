-- Eliminar todas las tablas con CASCADE
DROP TABLE IF EXISTS HISTORIAL_TICKET_USUARIO CASCADE;
DROP TABLE IF EXISTS TICKET CASCADE;
DROP TABLE IF EXISTS SOLICITUD_DOM_DISTRIBUIDOR CASCADE;
DROP TABLE IF EXISTS SOLICITUD_DOM_CLIENTE CASCADE;
DROP TABLE IF EXISTS USUARIO CASCADE;
DROP TABLE IF EXISTS DOMINIO CASCADE;
DROP TABLE IF EXISTS CLIENTE_DIRECTO CASCADE;
DROP TABLE IF EXISTS DISTRIBUIDOR CASCADE;
DROP TABLE IF EXISTS EMPLEADO CASCADE;
DROP TABLE IF EXISTS PLAN CASCADE;
DROP TABLE IF EXISTS ADMINISTRADOR CASCADE;
DROP TABLE IF EXISTS REGISTRADOR CASCADE;
DROP TABLE IF EXISTS TLD CASCADE;
DROP TABLE IF EXISTS TIPO_DOCUMENTO_EMP CASCADE;

-- Eliminar todos los tipos ENUM con CASCADE
DROP TYPE IF EXISTS estado_usuario CASCADE;
DROP TYPE IF EXISTS prioridad_enum CASCADE;
DROP TYPE IF EXISTS estado_ticket_enum CASCADE;
DROP TYPE IF EXISTS estado_solicitud_enum CASCADE;
DROP TYPE IF EXISTS cargo_empleado_enum CASCADE;
DROP TYPE IF EXISTS rol_usuario_enum CASCADE;
DROP TYPE IF EXISTS estado_dominio_enum CASCADE;


/* --- 1. Creación de ENUMS --- */
CREATE TYPE estado_usuario AS ENUM ('ACTIVO','INACTIVO','PENDIENTE');
CREATE TYPE prioridad_enum AS ENUM ('Baja', 'Media', 'Alta');
CREATE TYPE estado_ticket_enum AS ENUM ('Abierto', 'En Progreso', 'Cerrado', 'Escalado');
CREATE TYPE estado_solicitud_enum AS ENUM ('Aprobada', 'Rechazada', 'En Revisión');
CREATE TYPE cargo_empleado_enum AS ENUM ('Soporte', 'Coordinador');
CREATE TYPE rol_usuario_enum AS ENUM ('Cliente', 'Administrador', 'Empleado','Distribuidor');
CREATE TYPE estado_dominio_enum AS ENUM ('Disponible', 'En Uso', 'Reservado');

/* --- 2. Tablas base sin dependencias --- */
CREATE TABLE TIPO_DOCUMENTO_EMP (
   NOMBRE_TIPO_DOC VARCHAR(20) NOT NULL,
   CONSTRAINT PK_TIPO_DOCUMENTO_EMP PRIMARY KEY (NOMBRE_TIPO_DOC)
);

CREATE TABLE REGISTRADOR (
   ID_REGISTRADOR SERIAL NOT NULL,
   NOMBRE_REGISTRADOR VARCHAR(150) NOT NULL,
   CORREO_registrador VARCHAR(150) NOT NULL,
   CONSTRAINT PK_REGISTRADOR PRIMARY KEY (ID_REGISTRADOR)
);



CREATE TABLE ADMINISTRADOR (
   ID_ADMIN SERIAL NOT NULL,
   NOMBRE_ADMIN VARCHAR(50) NOT NULL,
   APELLIDO_ADMIN VARCHAR(50) NOT NULL,
   FECHA_NACIMIENTO_ADMIN DATE,
   CONSTRAINT PK_ADMINISTRADOR PRIMARY KEY (ID_ADMIN)
);

CREATE TABLE PLAN (
   ID_PLAN SERIAL NOT NULL,
   NOMBRE_PLAN VARCHAR(100) NOT NULL,
   PRECIO NUMERIC(12,2) NOT NULL DEFAULT 0,
   DESCRIPCION TEXT,
   CONSTRAINT PK_PLAN PRIMARY KEY (ID_PLAN)
);

CREATE TABLE EMPLEADO (
   ID_EMPLEADO SERIAL NOT NULL,
   NOMBRE_EMPLEADO VARCHAR(50) NOT NULL,
   APELLIDO_EMPLEADO VARCHAR(50) NOT NULL,
   CARGO_EMPLEADO cargo_empleado_enum NOT NULL,
   CONSTRAINT PK_EMPLEADO PRIMARY KEY (ID_EMPLEADO)
);

CREATE TABLE TLD (
   TLD VARCHAR(63) NOT NULL,
   CONSTRAINT PK_TLD PRIMARY KEY (TLD)
);

CREATE TABLE CLIENTE_DIRECTO (
   ID_CLIENTE SERIAL NOT NULL,
   ID_PLAN INT NULL,
   NOMBRE_CLIENTE VARCHAR(50) NOT NULL,
   APELLIDO_CLIENTE VARCHAR(50) NOT NULL,
   TELEFONO VARCHAR(20) NOT NULL,
   FECHA_NACIMIENTO_CLIENTE DATE NULL,
   FECHA_COMPRA_PLAN DATE NULL,
   CONSTRAINT PK_CLIENTE_DIRECTO PRIMARY KEY (ID_CLIENTE),
   CONSTRAINT FK_CLIENTE_PLAN FOREIGN KEY (ID_PLAN) 
       REFERENCES PLAN(ID_PLAN) 
       ON DELETE SET NULL,
   CONSTRAINT CHK_FECHA_NACIMIENTO CHECK (FECHA_NACIMIENTO_CLIENTE <= CURRENT_DATE)
);


CREATE TABLE DISTRIBUIDOR (
   ID_DISTRIBUIDOR SERIAL,
   NOMBRE_TIPO_DOC VARCHAR(20) NOT NULL,
   NUMERO_DOC_EMPRESA VARCHAR(20) NOT NULL,
   NOMBRE_EMPRESA VARCHAR(255) NOT NULL,
   DIRECCION_EMPRESA VARCHAR(255) NOT NULL,
   CONSTRAINT PK_DISTRIBUIDOR PRIMARY KEY (ID_DISTRIBUIDOR),
   CONSTRAINT FK_DISTRIBUIDOR_TDOC FOREIGN KEY (NOMBRE_TIPO_DOC) REFERENCES TIPO_DOCUMENTO_EMP(NOMBRE_TIPO_DOC)
);



CREATE TABLE USUARIO (
   ID_USUARIO SERIAL PRIMARY KEY,
   ID_CLIENTE INT NULL,
   ID_ADMIN INT NULL,
   ID_EMPLEADO INT NULL,
   ID_DISTRIBUIDOR INT NULL,
   CORREO_USUARIO VARCHAR(150) UNIQUE NOT NULL,
   CONTRASENA VARCHAR(150) NOT NULL,
   ROL rol_usuario_enum NOT NULL,
   ESTADO estado_usuario NOT NULL,
   CONSTRAINT FK_USUARIO_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE_DIRECTO(ID_CLIENTE),
   CONSTRAINT FK_USUARIO_ADMIN FOREIGN KEY (ID_ADMIN) REFERENCES ADMINISTRADOR(ID_ADMIN),
   CONSTRAINT FK_USUARIO_EMPLEADO FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO),
   CONSTRAINT FK_USUARIO_DISTRIBUIDOR FOREIGN KEY (ID_DISTRIBUIDOR) REFERENCES DISTRIBUIDOR(ID_DISTRIBUIDOR)
);


CREATE TABLE TICKET (
   ID_TICKET VARCHAR(100) NOT NULL,
   ID_DISTRIBUIDOR INT NULL,
   ID_CLIENTE INT NULL,
   ID_EMPLEADO INT NULL,
   ASUNTO VARCHAR(100) NOT NULL,
   DESCRIPCION TEXT NULL,
   PRIORIDAD prioridad_enum NULL,
   ESTADO estado_ticket_enum NOT NULL,
   CONSTRAINT PK_TICKET PRIMARY KEY (ID_TICKET),
   CONSTRAINT FK_TICKET_DISTRIBUIDOR FOREIGN KEY (ID_DISTRIBUIDOR) REFERENCES DISTRIBUIDOR(ID_DISTRIBUIDOR),
   CONSTRAINT FK_TICKET_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE_DIRECTO(ID_CLIENTE),
   CONSTRAINT FK_TICKET_EMPLEADO FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO)
);

CREATE TABLE HISTORIAL_TICKET_USUARIO (
   ID_TICKET VARCHAR(100) NOT NULL,
   ID_EMPLEADO INT NOT NULL,
   CONSTRAINT PK_SOLUCION PRIMARY KEY (ID_TICKET, ID_EMPLEADO),
   CONSTRAINT FK_SOLUCION_TICKET FOREIGN KEY (ID_TICKET) REFERENCES TICKET(ID_TICKET),
   CONSTRAINT FK_SOLUCION_EMPLEADO FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO)
);

/* --- 4. Tabla de solicitudes de dominio --- */

CREATE TABLE SOLICITUD_DOMINIO (
   ID_SOLICITUD SERIAL NOT NULL,
   ID_CLIENTE INT NULL,
   ID_DISTRIBUIDOR INT NULL,
   NOMBRE_DOMINIO VARCHAR(255) NOT NULL,
   TLD VARCHAR(63) NOT NULL,
   ESTADO_DOMINIO estado_dominio_enum NULL,
   ESTADO_SOLICITUD estado_solicitud_enum NOT NULL DEFAULT 'En Revisión',
   ID_ADMIN INT NULL,
   FECHA_SOLICITUD DATE NOT NULL,
   FECHA_APROBACION DATE NULL,

   CONSTRAINT PK_SOLICITUD_DOMINIO PRIMARY KEY (ID_SOLICITUD),

   CONSTRAINT FK_SOLICITUD_CLIENTE FOREIGN KEY (ID_CLIENTE)
       REFERENCES CLIENTE_DIRECTO(ID_CLIENTE) ON DELETE SET NULL,

   CONSTRAINT FK_SOLICITUD_DISTRIBUIDOR FOREIGN KEY (ID_DISTRIBUIDOR)
       REFERENCES DISTRIBUIDOR(ID_DISTRIBUIDOR) ON DELETE SET NULL,

   CONSTRAINT FK_SOLICITUD_TLD FOREIGN KEY (TLD)
       REFERENCES TLD(TLD) ON DELETE CASCADE,

   CONSTRAINT FK_SOLICITUD_ADMIN FOREIGN KEY (ID_ADMIN)
       REFERENCES ADMINISTRADOR(ID_ADMIN) ON DELETE SET NULL,

   CONSTRAINT CHK_SOLICITANTE CHECK (
       (ID_CLIENTE IS NOT NULL AND ID_DISTRIBUIDOR IS NULL) OR 
       (ID_CLIENTE IS NULL AND ID_DISTRIBUIDOR IS NOT NULL)
   )
);


create table metodo_pago()

     

     
